<%- include('layout', {
  title: 'รายละเอียดบ่อ ' + pond.pond_code,
  body: `
    <div class="row">
      <!-- Pond Info -->
      <div class="col-lg-4 mb-4">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="bi bi-droplet me-2"></i>บ่อ ${pond.pond_code}
            </h5>
          </div>
          <div class="card-body">
            <table class="table table-borderless">
              <tr>
                <td class="text-muted">โซน:</td>
                <td class="fw-bold">${pond.zone}</td>
              </tr>
              <tr>
                <td class="text-muted">ขนาด:</td>
                <td>${pond.size === 'large' ? 'ใหญ่' : pond.size === 'medium' ? 'กลาง' : 'เล็ก'}</td>
              </tr>
              <tr>
                <td class="text-muted">สถานะ:</td>
                <td>
                  <% if (pond.status === 'available' && !pond.user_name) { %>
                    <span class="badge bg-success">ว่าง</span>
                  <% } else if (pond.user_name) { %>
                    <span class="badge bg-danger">ใช้งาน</span>
                  <% } else if (pond.status === 'maintenance') { %>
                    <span class="badge bg-secondary">ปิดปรับปรุง</span>
                  <% } %>
                </td>
              </tr>
            </table>

            <% if (pond.user_name) { %>
              <hr>
              <h6><i class="bi bi-person me-2"></i>ข้อมูลการใช้งานปัจจุบัน</h6>
              <table class="table table-sm table-borderless">
                <tr>
                  <td class="text-muted">ผู้ใช้:</td>
                  <td class="fw-bold">${pond.user_name}</td>
                </tr>
                <tr>
                  <td class="text-muted">ชนิดปลา:</td>
                  <td>${pond.fish_type}</td>
                </tr>
                <tr>
                  <td class="text-muted">จำนวน:</td>
                  <td>${pond.fish_quantity?.toLocaleString() || '-'} ตัว</td>
                </tr>
                <tr>
                  <td class="text-muted">วันลงปลา:</td>
                  <td>${pond.start_date ? formatDate(pond.start_date) : '-'}</td>
                </tr>
                <tr>
                  <td class="text-muted">อายุปลา:</td>
                  <td><span class="badge bg-info">${pond.fish_age_days || 0} วัน</span></td>
                </tr>
                <tr>
                  <td class="text-muted">สิ้นสุด:</td>
                  <td>${pond.end_date ? formatDate(pond.end_date) : '-'}</td>
                </tr>
              </table>
            <% } %>

            <hr>
            <h6><i class="bi bi-gear me-2"></i>จัดการบ่อ</h6>
            <div class="d-grid gap-2">
              <% if (pond.user_name && pond.reservation_id) { %>
                <button class="btn btn-warning" onclick="completeReservation(${pond.reservation_id})">
                  <i class="bi bi-check2-circle me-2"></i>คืนบ่อ
                </button>
              <% } %>
              <% if (pond.status !== 'maintenance') { %>
                <button class="btn btn-secondary" onclick="setMaintenance(${pond.id})">
                  <i class="bi bi-tools me-2"></i>ปิดปรับปรุง
                </button>
              <% } else { %>
                <button class="btn btn-success" onclick="setAvailable(${pond.id})">
                  <i class="bi bi-check-circle me-2"></i>เปิดใช้งาน
                </button>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="col-lg-8 mb-4">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="bi bi-clock-history me-2"></i>ประวัติการใช้งาน
            </h5>
          </div>
          <div class="card-body p-0">
            <% if (history.length === 0) { %>
              <div class="text-center py-5 text-muted">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-2">ยังไม่มีประวัติการใช้งาน</p>
              </div>
            <% } else { %>
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>รหัส</th>
                      <th>ผู้จอง</th>
                      <th>ปลา</th>
                      <th>ระยะเวลา</th>
                      <th>สถานะ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% history.forEach(function(h) { %>
                      <tr>
                        <td>#REQ-${String(h.id).padStart(4, '0')}</td>
                        <td>${h.user_name}</td>
                        <td>${h.fish_type} (${h.fish_quantity.toLocaleString()})</td>
                        <td>${formatDate(h.start_date)} - ${formatDate(h.end_date)}</td>
                        <td>
                          <% if (h.status === 'pending') { %>
                            <span class="badge bg-warning text-dark">รออนุมัติ</span>
                          <% } else if (h.status === 'approved') { %>
                            <span class="badge bg-success">อนุมัติแล้ว</span>
                          <% } else if (h.status === 'rejected') { %>
                            <span class="badge bg-danger">ไม่อนุมัติ</span>
                          <% } else if (h.status === 'cancelled') { %>
                            <span class="badge bg-secondary">ยกเลิก</span>
                          <% } else if (h.status === 'completed') { %>
                            <span class="badge bg-info">เสร็จสิ้น</span>
                          <% } %>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  `,
  scripts: \`
    <script>
      async function completeReservation(id) {
        if (!confirm('ยืนยันการคืนบ่อ?')) return;
        try {
          const res = await fetch('/admin/reservations/' + id + '/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          if (res.ok) {
            showToast('คืนบ่อเรียบร้อย', 'success');
            setTimeout(() => location.reload(), 1000);
          }
        } catch (err) {
          showToast('เกิดข้อผิดพลาด', 'danger');
        }
      }

      async function setMaintenance(id) {
        if (!confirm('ยืนยันการปิดปรับปรุงบ่อ?')) return;
        try {
          const res = await fetch('/admin/pond/' + id + '/status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'maintenance' })
          });
          if (res.ok) {
            showToast('ปิดปรับปรุงเรียบร้อย', 'success');
            setTimeout(() => location.reload(), 1000);
          }
        } catch (err) {
          showToast('เกิดข้อผิดพลาด', 'danger');
        }
      }

      async function setAvailable(id) {
        if (!confirm('ยืนยันการเปิดใช้งานบ่อ?')) return;
        try {
          const res = await fetch('/admin/pond/' + id + '/status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'available' })
          });
          if (res.ok) {
            showToast('เปิดใช้งานเรียบร้อย', 'success');
            setTimeout(() => location.reload(), 1000);
          }
        } catch (err) {
          showToast('เกิดข้อผิดพลาด', 'danger');
        }
      }
    </script>
  \`
}) %>

<%
function formatDate(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  const thaiMonths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
  return date.getDate() + ' ' + thaiMonths[date.getMonth()] + ' ' + (date.getFullYear() + 543);
}
%>
